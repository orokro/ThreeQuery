"use strict";class n{constructor(t){this.scene=t,this.idMap=new Map,this.classMap=new Map,this.loaders=new Map,this.scan(t)}addLoader(t,s){this.loaders.set(t,s)}async loadGeometry(t,s){const e=this.loaders.get(t);if(!e)throw new Error(`No loader for type ${t}`);const a=await e(s);return this.scan(a),a}scan(t){t.traverse(s=>{if(!s.userData.name)return;const{id:e,classes:a}=n.parseName(s.userData.name);e&&(this.idMap.has(e)||this.idMap.set(e,[]),this.idMap.get(e).push(s));for(let r of a)this.classMap.has(r)||this.classMap.set(r,[]),this.classMap.get(r).push(s);s._threeQueryMeta={id:e,classes:new Set(a)}})}static parseName(t){const s=t.match(/#(\w+)/),e=[...t.matchAll(/\.(\w+)/g)].map(a=>a[1]);return{id:s?s[1]:null,classes:e||[]}}query(t,s=this.scene){const e=t.trim().split(/\s+/),a=(r,i)=>{if(i>=e.length)return r;const h=e[i];let c=new Set;return r.forEach(l=>{l.traverse(u=>{n.matches(u,h)&&c.add(u)})}),a(c,i+1)};return new o([...a(new Set([s]),0)],this)}static matches(t,s){if(!t._threeQueryMeta)return!1;const{id:e,classes:a}=t._threeQueryMeta,r=s.match(/^#(\w+)/),i=[...s.matchAll(/\.(\w+)/g)].map(h=>h[1]);if(r&&e!==r[1])return!1;for(let h of i)if(!a.has(h))return!1;return!0}$(t){return this.query(t)}}class o{constructor(t,s){this.objects=t,this.root=s}each(t){return this.objects.forEach(t),this}find(t){const s=[];return this.objects.forEach(e=>{const a=this.root.query(t,e);s.push(...a.objects)}),new o(s,this.root)}scale(t,s,e){var a;return t===void 0?(a=this.objects[0])==null?void 0:a.scale:(this.each(r=>r.scale.set(t,s,e)),this)}pos(t,s,e){var a;return t===void 0?(a=this.objects[0])==null?void 0:a.position:(this.each(r=>r.position.set(t,s,e)),this)}rot(t,s,e){var a;return t===void 0?(a=this.objects[0])==null?void 0:a.rotation:(typeof t=="object"?this.each(r=>r.quaternion.copy(t)):this.each(r=>r.rotation.set(t,s,e)),this)}material(t,s=!1){var e;return t?(this.each(a=>{const r=Array.isArray(a.material)?a.material:[a.material];(s?r:[r[0]]).forEach(i=>{Object.entries(t).forEach(([h,c])=>{h in i?i[h]=c:console.warn(`Property ${h} not in material`)})})}),this):(e=this.objects[0])==null?void 0:e.material}toggle(){return this.each(t=>t.visible=!t.visible),this}show(t){var s;return t===void 0?(s=this.objects[0])==null?void 0:s.visible:(this.each(e=>e.visible=t),this)}id(t){var s,e;return t?(this.each(a=>{var i;const r=a._threeQueryMeta.id;r&&((i=this.root.idMap.get(r))==null||i.splice(this.root.idMap.get(r).indexOf(a),1)),a._threeQueryMeta.id=t,a.userData.name=`#${t}`,this.root.idMap.has(t)||this.root.idMap.set(t,[]),this.root.idMap.get(t).push(a)}),this):(e=(s=this.objects[0])==null?void 0:s._threeQueryMeta)==null?void 0:e.id}addClass(t){return this.each(s=>{s._threeQueryMeta.classes.add(t),s.userData.name+=` .${t}`,this.root.classMap.has(t)||this.root.classMap.set(t,[]),this.root.classMap.get(t).push(s)}),this}removeClass(t){return this.each(s=>{var e;s._threeQueryMeta.classes.delete(t),s.userData.name=s.userData.name.replace(new RegExp(`\\.${t}`),""),(e=this.root.classMap.get(t))==null||e.splice(this.root.classMap.get(t).indexOf(s),1)}),this}toggleClass(t){return this.each(s=>{s._threeQueryMeta.classes.has(t)?this.removeClass(t):this.addClass(t)}),this}class(){var t,s;return[...((s=(t=this.objects[0])==null?void 0:t._threeQueryMeta)==null?void 0:s.classes)||[]]}parent(t){var e;if(!t)return(e=this.objects[0])==null?void 0:e.parent;const s=t instanceof o?t.objects[0]:t;return this.each(a=>s.add(a)),this}clone(){const t=this.objects.map(s=>s.clone(!0));return new o(t,this.root)}object(){return this.objects}}module.exports=n;
