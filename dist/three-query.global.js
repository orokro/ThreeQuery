(function(n,h){typeof exports=="object"&&typeof module<"u"?module.exports=h():typeof define=="function"&&define.amd?define(h):(n=typeof globalThis<"u"?globalThis:n||self,n.ThreeQuery=h())})(this,function(){"use strict";class n{constructor(t){this.scene=t,this.idMap=new Map,this.classMap=new Map,this.loaders=new Map,this.scan(t)}addLoader(t,e){this.loaders.set(t,e)}async loadGeometry(t,e){const s=this.loaders.get(t);if(!s)throw new Error(`No loader for type ${t}`);const a=await s(e);return this.scan(a),a}scan(t){t.traverse(e=>{if(!e.userData.name)return;const{id:s,classes:a}=n.parseName(e.userData.name);s&&(this.idMap.has(s)||this.idMap.set(s,[]),this.idMap.get(s).push(e));for(let r of a)this.classMap.has(r)||this.classMap.set(r,[]),this.classMap.get(r).push(e);e._threeQueryMeta={id:s,classes:new Set(a)}})}static parseName(t){const e=t.match(/#(\w+)/),s=[...t.matchAll(/\.(\w+)/g)].map(a=>a[1]);return{id:e?e[1]:null,classes:s||[]}}query(t,e=this.scene){const s=t.trim().split(/\s+/),a=(r,i)=>{if(i>=s.length)return r;const o=s[i];let c=new Set;return r.forEach(l=>{l.traverse(u=>{n.matches(u,o)&&c.add(u)})}),a(c,i+1)};return new h([...a(new Set([e]),0)],this)}static matches(t,e){if(!t._threeQueryMeta)return!1;const{id:s,classes:a}=t._threeQueryMeta,r=e.match(/^#(\w+)/),i=[...e.matchAll(/\.(\w+)/g)].map(o=>o[1]);if(r&&s!==r[1])return!1;for(let o of i)if(!a.has(o))return!1;return!0}$(t){return this.query(t)}}class h{constructor(t,e){this.objects=t,this.root=e}each(t){return this.objects.forEach(t),this}find(t){const e=[];return this.objects.forEach(s=>{const a=this.root.query(t,s);e.push(...a.objects)}),new h(e,this.root)}scale(t,e,s){var a;return t===void 0?(a=this.objects[0])==null?void 0:a.scale:(this.each(r=>r.scale.set(t,e,s)),this)}pos(t,e,s){var a;return t===void 0?(a=this.objects[0])==null?void 0:a.position:(this.each(r=>r.position.set(t,e,s)),this)}rot(t,e,s){var a;return t===void 0?(a=this.objects[0])==null?void 0:a.rotation:(typeof t=="object"?this.each(r=>r.quaternion.copy(t)):this.each(r=>r.rotation.set(t,e,s)),this)}material(t,e=!1){var s;return t?(this.each(a=>{const r=Array.isArray(a.material)?a.material:[a.material];(e?r:[r[0]]).forEach(i=>{Object.entries(t).forEach(([o,c])=>{o in i?i[o]=c:console.warn(`Property ${o} not in material`)})})}),this):(s=this.objects[0])==null?void 0:s.material}toggle(){return this.each(t=>t.visible=!t.visible),this}show(t){var e;return t===void 0?(e=this.objects[0])==null?void 0:e.visible:(this.each(s=>s.visible=t),this)}id(t){var e,s;return t?(this.each(a=>{var i;const r=a._threeQueryMeta.id;r&&((i=this.root.idMap.get(r))==null||i.splice(this.root.idMap.get(r).indexOf(a),1)),a._threeQueryMeta.id=t,a.userData.name=`#${t}`,this.root.idMap.has(t)||this.root.idMap.set(t,[]),this.root.idMap.get(t).push(a)}),this):(s=(e=this.objects[0])==null?void 0:e._threeQueryMeta)==null?void 0:s.id}addClass(t){return this.each(e=>{e._threeQueryMeta.classes.add(t),e.userData.name+=` .${t}`,this.root.classMap.has(t)||this.root.classMap.set(t,[]),this.root.classMap.get(t).push(e)}),this}removeClass(t){return this.each(e=>{var s;e._threeQueryMeta.classes.delete(t),e.userData.name=e.userData.name.replace(new RegExp(`\\.${t}`),""),(s=this.root.classMap.get(t))==null||s.splice(this.root.classMap.get(t).indexOf(e),1)}),this}toggleClass(t){return this.each(e=>{e._threeQueryMeta.classes.has(t)?this.removeClass(t):this.addClass(t)}),this}class(){var t,e;return[...((e=(t=this.objects[0])==null?void 0:t._threeQueryMeta)==null?void 0:e.classes)||[]]}parent(t){var s;if(!t)return(s=this.objects[0])==null?void 0:s.parent;const e=t instanceof h?t.objects[0]:t;return this.each(a=>e.add(a)),this}clone(){const t=this.objects.map(e=>e.clone(!0));return new h(t,this.root)}object(){return this.objects}}return n});
